<!DOCTYPE html>
<html lang="en">
<head>
    <title>Medical Chatbot</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap -->
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

    <!-- Icons -->
    <link rel="stylesheet"
          href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Custom CSS (UNCHANGED) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="medical-ui">

<div class="container-fluid h-100">
    <div class="row justify-content-center align-items-center h-100">
        <div class="col-md-8 col-xl-6 chat">
            <div class="card">

                <!-- HEADER -->
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="img_cont position-relative">
                            <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png"
                                 class="rounded-circle user_img">
                            <span class="online_icon"></span>
                        </div>
                        <div class="user_info ml-3">
                            <span>Medical AI Assistant</span>
                            <p>Evidence-based • Context-aware</p>
                        </div>
                    </div>
                </div>

                <!-- CHAT BODY -->
                <div id="messageFormeight" class="card-body msg_card_body"></div>

                <!-- FOOTER -->
                <div class="card-footer">
                    <form id="messageArea" class="input-group">
                        <input type="text"
                               id="text"
                               name="msg"
                               class="form-control type_msg"
                               placeholder="Ask a medical question..."
                               autocomplete="off"
                               required>
                        <div class="input-group-append">
                            <button type="submit"
                                    id="send"
                                    class="input-group-text send_btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- =========================
     JAVASCRIPT
========================= -->
<script>
$(document).ready(function () {

    /* ---------- Sounds ---------- */
    const sendSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3");
    const replySound = new Audio("https://assets.mixkit.co/active_storage/sfx/270/270-preview.mp3");
    sendSound.volume = 0.4;
    replySound.volume = 0.4;

    function playSendSound() {
        sendSound.currentTime = 0;
        sendSound.play().catch(()=>{});
    }

    function playReplySound() {
        replySound.currentTime = 0;
        replySound.play().catch(()=>{});
    }

    /* ---------- Fix Missing Gaps ---------- */
    function fixTextSpacing(text) {
        return text
            .replace(/([.,!?])/g, "$1 ")
            .replace(/([a-z])([A-Z])/g, "$1 $2")
            .replace(/\s+/g, " ")
            .trim();
    }

    /* ---------- Thinking Indicator ---------- */
    function showThinking() {
        const thinkingHtml =
            '<div id="ai-thinking" class="d-flex justify-content-start mb-4">' +
                '<div class="img_cont_msg">' +
                    '<img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle user_img_msg">' +
                '</div>' +
                '<div class="msg_cotainer"><em>Just a moment…</em></div>' +
            '</div>';
        $("#messageFormeight").append(thinkingHtml);
    }

    function removeThinking() {
        $("#ai-thinking").remove();
    }

    /* ---------- Markdown Formatter ---------- */
    function formatBotResponse(text) {
        if (!text) return "";
        text = text.trim();
        text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        text = text.replace(/\n\s*\n+/g, "\n");
        text = text.replace(/\n/g, "<br>");
        return text;
    }

    /* ---------- Chat Submit ---------- */
    $("#messageArea").on("submit", function (event) {
        event.preventDefault();

        const time = new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit"
        });

        const rawText = $("#text").val();
        if (!rawText.trim()) return;

        const userHtml =
            '<div class="d-flex justify-content-end mb-4">' +
                '<div class="msg_cotainer_send">' +
                    rawText +
                    '<span class="msg_time_send">' + time + '</span>' +
                '</div>' +
                '<div class="img_cont_msg">' +
                    '<img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg">' +
                '</div>' +
            '</div>';

        $("#text").val("");
        $("#messageFormeight").append(userHtml);
        playSendSound();
        showThinking();

        $.ajax({
            type: "POST",
            url: "/get",
            data: { msg: rawText }
        }).done(function (data) {

            removeThinking();
            playReplySound();

            let formattedData = formatBotResponse(data);
            formattedData = fixTextSpacing(formattedData);

            const botHtml =
                '<div class="d-flex justify-content-start mb-4">' +
                    '<div class="img_cont_msg">' +
                        '<img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle user_img_msg">' +
                    '</div>' +
                    '<div class="msg_cotainer">' +
                        formattedData +
                        '<span class="msg_time">' + time + '</span>' +
                    '</div>' +
                '</div>';

            $("#messageFormeight").append(botHtml);
            $("#messageFormeight").scrollTop(
                $("#messageFormeight")[0].scrollHeight
            );
        });
    });
});
</script>

</body>
</html>